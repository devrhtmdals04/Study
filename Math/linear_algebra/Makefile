VENV_PYTHON := .venv/bin/python
PYTHON ?= $(if $(wildcard $(VENV_PYTHON)),$(VENV_PYTHON),python3)

CACHE_DIR ?= $(CURDIR)/.cache
MPLCONFIGDIR ?= $(CACHE_DIR)/matplotlib
XDG_CACHE_HOME ?= $(CACHE_DIR)
IPYTHONDIR ?= $(CACHE_DIR)/ipython
JUPYTER_CONFIG_DIR ?= $(CACHE_DIR)/jupyter/config
JUPYTER_DATA_DIR ?= $(CACHE_DIR)/jupyter/data
JUPYTER_RUNTIME_DIR ?= $(CACHE_DIR)/jupyter/runtime

.PHONY: venv install cache lab01 lab02 lab03 viz01 viz02 viz03 jupyter

venv:
	$(PYTHON) -m venv .venv

install: venv
	. .venv/bin/activate; python -m pip install -r requirements.txt

cache:
	mkdir -p "$(CACHE_DIR)/fontconfig" "$(MPLCONFIGDIR)" "$(IPYTHONDIR)" "$(JUPYTER_CONFIG_DIR)" "$(JUPYTER_DATA_DIR)" "$(JUPYTER_RUNTIME_DIR)"

lab01:
	$(MAKE) cache
	XDG_CACHE_HOME="$(XDG_CACHE_HOME)" MPLCONFIGDIR="$(MPLCONFIGDIR)" IPYTHONDIR="$(IPYTHONDIR)" JUPYTER_CONFIG_DIR="$(JUPYTER_CONFIG_DIR)" JUPYTER_DATA_DIR="$(JUPYTER_DATA_DIR)" JUPYTER_RUNTIME_DIR="$(JUPYTER_RUNTIME_DIR)" $(PYTHON) -m labs.lab01_vectors

lab02:
	$(MAKE) cache
	XDG_CACHE_HOME="$(XDG_CACHE_HOME)" MPLCONFIGDIR="$(MPLCONFIGDIR)" IPYTHONDIR="$(IPYTHONDIR)" JUPYTER_CONFIG_DIR="$(JUPYTER_CONFIG_DIR)" JUPYTER_DATA_DIR="$(JUPYTER_DATA_DIR)" JUPYTER_RUNTIME_DIR="$(JUPYTER_RUNTIME_DIR)" $(PYTHON) -m labs.lab02_linear_systems

lab03:
	$(MAKE) cache
	XDG_CACHE_HOME="$(XDG_CACHE_HOME)" MPLCONFIGDIR="$(MPLCONFIGDIR)" IPYTHONDIR="$(IPYTHONDIR)" JUPYTER_CONFIG_DIR="$(JUPYTER_CONFIG_DIR)" JUPYTER_DATA_DIR="$(JUPYTER_DATA_DIR)" JUPYTER_RUNTIME_DIR="$(JUPYTER_RUNTIME_DIR)" $(PYTHON) -m labs.lab03_inverse_det

viz01:
	$(MAKE) cache
	XDG_CACHE_HOME="$(XDG_CACHE_HOME)" MPLCONFIGDIR="$(MPLCONFIGDIR)" IPYTHONDIR="$(IPYTHONDIR)" JUPYTER_CONFIG_DIR="$(JUPYTER_CONFIG_DIR)" JUPYTER_DATA_DIR="$(JUPYTER_DATA_DIR)" JUPYTER_RUNTIME_DIR="$(JUPYTER_RUNTIME_DIR)" $(PYTHON) -m labs.viz01_vectors_2d

viz02:
	$(MAKE) cache
	XDG_CACHE_HOME="$(XDG_CACHE_HOME)" MPLCONFIGDIR="$(MPLCONFIGDIR)" IPYTHONDIR="$(IPYTHONDIR)" JUPYTER_CONFIG_DIR="$(JUPYTER_CONFIG_DIR)" JUPYTER_DATA_DIR="$(JUPYTER_DATA_DIR)" JUPYTER_RUNTIME_DIR="$(JUPYTER_RUNTIME_DIR)" $(PYTHON) -m labs.viz02_linear_transform_2d

viz03:
	$(MAKE) cache
	XDG_CACHE_HOME="$(XDG_CACHE_HOME)" MPLCONFIGDIR="$(MPLCONFIGDIR)" IPYTHONDIR="$(IPYTHONDIR)" JUPYTER_CONFIG_DIR="$(JUPYTER_CONFIG_DIR)" JUPYTER_DATA_DIR="$(JUPYTER_DATA_DIR)" JUPYTER_RUNTIME_DIR="$(JUPYTER_RUNTIME_DIR)" $(PYTHON) -m labs.viz03_vectors_3d

jupyter:
	$(MAKE) cache
	. .venv/bin/activate; XDG_CACHE_HOME="$(XDG_CACHE_HOME)" MPLCONFIGDIR="$(MPLCONFIGDIR)" IPYTHONDIR="$(IPYTHONDIR)" JUPYTER_CONFIG_DIR="$(JUPYTER_CONFIG_DIR)" JUPYTER_DATA_DIR="$(JUPYTER_DATA_DIR)" JUPYTER_RUNTIME_DIR="$(JUPYTER_RUNTIME_DIR)" jupyter lab
